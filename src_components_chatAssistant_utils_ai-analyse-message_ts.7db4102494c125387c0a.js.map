{"version":3,"file":"src_components_chatAssistant_utils_ai-analyse-message_ts.7db4102494c125387c0a.js","mappings":"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","sources":["webpack://TelyAI/./src/components/chatAssistant/utils/ai-analyse-message.ts","webpack://TelyAI/ignored|/Users/qmk/work/telegram-tt/node_modules/pdfjs-dist/legacy/build|fs","webpack://TelyAI/ignored|/Users/qmk/work/telegram-tt/node_modules/pdfjs-dist/legacy/build|http","webpack://TelyAI/ignored|/Users/qmk/work/telegram-tt/node_modules/pdfjs-dist/legacy/build|canvas","webpack://TelyAI/ignored|/Users/qmk/work/telegram-tt/node_modules/pdfjs-dist/legacy/build|zlib","webpack://TelyAI/ignored|/Users/qmk/work/telegram-tt/node_modules/pdfjs-dist/legacy/build|url","webpack://TelyAI/ignored|/Users/qmk/work/telegram-tt/node_modules/pdfjs-dist/legacy/build|https"],"sourcesContent":["/* eslint-disable */\nimport { v4 as uuidv4 } from \"uuid\";\nimport { ApiMessage } from \"../../../api/types\";\nimport eventEmitter, { Actions } from \"../lib/EventEmitter\";\nimport { ChataiStores } from \"../store\";\nimport { StoreMessage } from \"../store/messages-store\";\nimport {\n  audioAISummary,\n  documentAISummary,\n  imageAISummary,\n  mentionReply,\n  webPageAISummary,\n} from \"./chat-api\";\nimport { sleep } from \"../ai-chatfolders/util\";\nimport { getMediaHash } from \"../../../global/helpers\";\nimport * as mediaLoader from \"../../../util/mediaLoader\";\nimport { message as showMessage } from \"antd\";\nimport * as pdfjsLib from \"pdfjs-dist/legacy/build/pdf\";\nimport { getActions, getGlobal } from \"../../../global\";\nimport {\n  selectChatMessage,\n  selectWebPageFromMessage,\n} from \"../../../global/selectors\";\n\npdfjsLib.GlobalWorkerOptions.workerSrc = \"pdf.worker.min.js\";\n\nconst mammoth = require(\"mammoth\");\n\nexport async function replyToMention(\n  message: ApiMessage,\n  isAuto: boolean = false\n) {\n  if (!message.isMentioned || !message.content?.text?.text) return;\n\n  let newMessage: StoreMessage = {\n    chatId: message.chatId,\n    timestamp: new Date().getTime(),\n    id: uuidv4(),\n    createdAt: new Date(),\n    role: \"assistant\",\n    annotations: [{ type: \"room-ai-reply-mention\" }],\n    content: JSON.stringify({\n      messageId: message.id,\n      content: message.content.text?.text,\n      isAuto,\n      status: \"loading\",\n    }),\n  };\n  await sendMessageToAIRoom(newMessage);\n\n  mentionReply({\n    message: message.content.text?.text,\n    language: getAutoTransLang(),\n  })\n    .then((response: any) => {\n      if (response.text) {\n        newMessage = {\n          ...newMessage,\n          content: JSON.stringify({\n            messageId: message.id,\n            content: message.content.text?.text,\n            replys: response.text,\n            isAuto,\n            status: \"success\",\n          }),\n        };\n        sendMessageToAIRoom(newMessage);\n      } else {\n        sendErrorMessage(newMessage, message, isAuto);\n      }\n    })\n    .catch((err) => {\n      console.log(\"error\", err);\n      sendErrorMessage(newMessage, message, isAuto);\n    });\n}\n\nexport async function photoSummary(\n  message: ApiMessage,\n  isAuto: boolean = false\n) {\n  const photo = message.content?.photo;\n  if (!photo) return;\n  const mediaHash = getMediaHash(photo, \"download\");\n  if (!mediaHash) return;\n  const mimeType = \"image/jpeg\";\n\n  let newMessage: StoreMessage = {\n    chatId: message.chatId,\n    timestamp: new Date().getTime(),\n    id: uuidv4(),\n    createdAt: new Date(),\n    role: \"assistant\",\n    annotations: [{ type: \"room-ai-media-summary\" }],\n    content: JSON.stringify({ message, isAuto, status: \"loading\" }),\n  };\n  await sendMessageToAIRoom(newMessage);\n\n  await handleImageToSummaryText({\n    mimeType,\n    mediaHash,\n    message,\n    newMessage,\n    isAuto,\n  });\n}\n\nexport async function webPageSummary(\n  message: ApiMessage,\n  isAuto: boolean = false\n) {\n  // const webPage = message.content?.webPage;\n  const global = getGlobal();\n  const webPage = selectWebPageFromMessage(global, message);\n  const url = webPage ? webPage?.url : message.content?.text?.text;\n  if (!url || url === \"\") return;\n\n  let newMessage: StoreMessage = {\n    chatId: message.chatId,\n    timestamp: new Date().getTime(),\n    id: uuidv4(),\n    createdAt: new Date(),\n    role: \"assistant\",\n    annotations: [{ type: \"room-ai-media-summary\" }],\n    content: JSON.stringify({ message, isAuto, status: \"loading\" }),\n  };\n  await sendMessageToAIRoom(newMessage);\n\n  webPageAISummary({\n    url,\n    text: message.content?.text?.text || \"\",\n    language: getAutoTransLang(),\n  })\n    .then((response: any) => {\n      if (response?.text) {\n        newMessage = {\n          ...newMessage,\n          content: JSON.stringify({\n            message,\n            summaryInfo: response?.text,\n            isAuto,\n            status: \"success\",\n          }),\n        };\n        sendMessageToAIRoom(newMessage);\n      } else {\n        sendErrorMessage(newMessage, message, isAuto);\n      }\n    })\n    .catch((err) => {\n      console.log(\"error\", err);\n      sendErrorMessage(newMessage, message, isAuto);\n    });\n}\n\nexport async function documentSummary(\n  message: ApiMessage,\n  isAuto: boolean = false\n) {\n  const document = message.content?.document;\n  if (!document) return;\n\n  const mediaHash = getMediaHash(document, \"download\");\n  if (!mediaHash) return;\n  if (checkIsImage(document.mimeType) && isAuto) return;\n\n  let newMessage: StoreMessage = {\n    chatId: message.chatId,\n    timestamp: new Date().getTime(),\n    id: uuidv4(),\n    createdAt: new Date(),\n    role: \"assistant\",\n    annotations: [{ type: \"room-ai-media-summary\" }],\n    content: JSON.stringify({ message, isAuto, status: \"loading\" }),\n  };\n  await sendMessageToAIRoom(newMessage);\n\n  // image\n  if (checkIsImage(document.mimeType)) {\n    handleImageToSummaryText({\n      mimeType: document.mimeType,\n      mediaHash,\n      message,\n      newMessage,\n      isAuto,\n    });\n    return;\n  }\n  // video\n  if (checkIsVideo(document.mimeType)) {\n    await handleAudioToSummaryText({\n      mediaHash,\n      mimeType: document?.mimeType,\n      filename: document?.fileName,\n      size: document?.size,\n      newMessage,\n      message,\n      isAuto,\n    });\n    return;\n  }\n\n  await mediaLoader.fetch(mediaHash, 0);\n  const blobUrl = mediaLoader.getFromMemory(mediaHash);\n  if (!blobUrl) return;\n\n  const response = await fetch(blobUrl);\n  const blob = await response.blob();\n\n  const arrayBuffer = await blob.arrayBuffer();\n  let text = \"\";\n  switch (document.mimeType) {\n    case \"text/plain\":\n      text = new TextDecoder().decode(arrayBuffer);\n      break;\n    case \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\":\n    case \"application/msword\":\n      const result = await mammoth.extractRawText({ arrayBuffer });\n      text = result.value;\n      break;\n    case \"application/pdf\":\n      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;\n      let pdfText = \"\";\n      for (let i = 1; i <= pdf.numPages; i++) {\n        const page = await pdf.getPage(i);\n        const content = await page.getTextContent();\n        const pageText = content.items.map((item: any) => item.str).join(\" \");\n        pdfText += pageText + \"\\n\";\n      }\n      text = pdfText;\n      break;\n    default:\n      await sendErrorMessage(newMessage, message, isAuto);\n      return;\n  }\n  if (text === \"\") {\n    await sendErrorMessage(newMessage, message, isAuto);\n    return;\n  }\n\n  documentAISummary({\n    content: text,\n    language: getAutoTransLang(),\n  })\n    .then((response: any) => {\n      if (response?.text) {\n        newMessage = {\n          ...newMessage,\n          content: JSON.stringify({\n            message: message,\n            summaryInfo: response?.text,\n            isAuto,\n            status: \"success\",\n          }),\n        };\n        sendMessageToAIRoom(newMessage);\n      } else {\n        sendErrorMessage(newMessage, message, isAuto);\n      }\n    })\n    .catch((err) => {\n      console.log(\"error\", err);\n      sendErrorMessage(newMessage, message, isAuto);\n    });\n}\n\nexport async function voiceSummary(\n  message: ApiMessage,\n  isAuto: boolean = false\n) {\n  const voice = message.content?.voice;\n  if (!voice) return;\n\n  let newMessage: StoreMessage = {\n    chatId: message.chatId,\n    timestamp: new Date().getTime(),\n    id: uuidv4(),\n    createdAt: new Date(),\n    role: \"assistant\",\n    annotations: [{ type: \"room-ai-media-summary\" }],\n    content: JSON.stringify({ message, isAuto, status: \"loading\" }),\n  };\n  await sendMessageToAIRoom(newMessage);\n\n  let text = \"\";\n  const global = getGlobal();\n  const { isTranscriptionError, transcriptionId } = message;\n  if (isTranscriptionError) {\n    sendErrorMessage(newMessage, message, isAuto);\n    return;\n  }\n  if (transcriptionId && transcriptionId !== \"\") {\n    text = global?.transcriptions?.[transcriptionId]?.text;\n  } else {\n    await getActions().transcribeAudio({\n      chatId: message.chatId,\n      messageId: message.id,\n    });\n    await sleep(2000);\n    const newGlobal = getGlobal();\n    const currentMessage = selectChatMessage(\n      newGlobal,\n      message.chatId,\n      message.id\n    );\n    if (currentMessage?.isTranscriptionError) {\n      sendErrorMessage(newMessage, message, isAuto);\n      return;\n    }\n    if (\n      currentMessage?.transcriptionId &&\n      currentMessage?.transcriptionId !== \"\"\n    ) {\n      text = newGlobal.transcriptions?.[currentMessage?.transcriptionId]?.text;\n    }\n  }\n  if (text === \"\") {\n    await sendErrorMessage(newMessage, message, isAuto);\n    return;\n  }\n  documentAISummary({\n    content: text,\n    language: getAutoTransLang(),\n  })\n    .then((response: any) => {\n      if (response?.text) {\n        newMessage = {\n          ...newMessage,\n          content: JSON.stringify({\n            message: message,\n            summaryInfo: response?.text,\n            isAuto,\n            status: \"success\",\n          }),\n        };\n        sendMessageToAIRoom(newMessage);\n      } else {\n        sendErrorMessage(newMessage, message, isAuto);\n      }\n    })\n    .catch((err) => {\n      console.log(\"error\", err);\n      sendErrorMessage(newMessage, message, isAuto);\n    });\n}\n\nexport async function voiceToAudioSummary(\n  message: ApiMessage,\n  isAuto: boolean = false\n) {\n  const voice = message.content?.voice;\n  if (!voice) return;\n  const mediaHash = getMediaHash(voice, \"download\");\n  if (!mediaHash) return;\n  const maxBase64Length = Math.floor(4 * 1024 * 1024);\n  if (\n    message.content.audio?.size &&\n    message.content.audio?.size * (4 / 3) > maxBase64Length\n  ) {\n    showMessage.info(\"File size exceeds limit (4 MB)\");\n    return;\n  }\n  //\n  let newMessage: StoreMessage = {\n    chatId: message.chatId,\n    timestamp: new Date().getTime(),\n    id: uuidv4(),\n    createdAt: new Date(),\n    role: \"assistant\",\n    annotations: [{ type: \"room-ai-media-summary\" }],\n    content: JSON.stringify({ message, isAuto, status: \"loading\" }),\n  };\n  await sendMessageToAIRoom(newMessage);\n\n  await handleAudioToSummaryText({\n    mediaHash,\n    mimeType: \"audio/ogg\",\n    filename: voice?.id + \".ogg\",\n    size: voice?.size,\n    newMessage,\n    message,\n    isAuto,\n  });\n}\n\nexport async function audioSummary(\n  message: ApiMessage,\n  isAuto: boolean = false\n) {\n  const audio = message.content?.audio;\n  if (!audio) return;\n  const mediaHash = getMediaHash(audio, \"download\");\n  if (!mediaHash) return;\n  //\n  let newMessage: StoreMessage = {\n    chatId: message.chatId,\n    timestamp: new Date().getTime(),\n    id: uuidv4(),\n    createdAt: new Date(),\n    role: \"assistant\",\n    annotations: [{ type: \"room-ai-media-summary\" }],\n    content: JSON.stringify({ message, isAuto, status: \"loading\" }),\n  };\n  await sendMessageToAIRoom(newMessage);\n\n  await handleAudioToSummaryText({\n    mediaHash,\n    mimeType: audio?.mimeType,\n    filename: audio?.fileName,\n    size: audio?.size,\n    newMessage,\n    message,\n    isAuto,\n  });\n}\n\nexport async function videoSummary(\n  message: ApiMessage,\n  isAuto: boolean = false\n) {\n  const video = message.content?.video;\n  if (!video) return;\n  const mediaHash = getMediaHash(video, \"download\");\n  if (!mediaHash) return;\n  //\n  let newMessage: StoreMessage = {\n    chatId: message.chatId,\n    timestamp: new Date().getTime(),\n    id: uuidv4(),\n    createdAt: new Date(),\n    role: \"assistant\",\n    annotations: [{ type: \"room-ai-media-summary\" }],\n    content: JSON.stringify({ message, isAuto, status: \"loading\" }),\n  };\n  await sendMessageToAIRoom(newMessage);\n  if (video?.mimeType !== \"video/mp4\") {\n    await sendErrorMessage(newMessage, message, isAuto);\n    return;\n  }\n\n  await handleAudioToSummaryText({\n    mediaHash,\n    mimeType: video?.mimeType,\n    filename: video?.fileName,\n    size: video?.size,\n    newMessage,\n    message,\n    isAuto,\n  });\n}\n\nasync function sendMessageToAIRoom(newMessage: StoreMessage) {\n  await ChataiStores.message?.storeMessage(newMessage);\n  await eventEmitter.emit(Actions.AddRoomAIMessage, newMessage);\n}\n\nasync function handleAudioToSummaryText({\n  mediaHash,\n  mimeType,\n  filename,\n  size,\n  newMessage,\n  message,\n  isAuto,\n}: {\n  mediaHash: string;\n  mimeType?: string;\n  filename?: string;\n  size?: number;\n  newMessage: StoreMessage;\n  message: ApiMessage;\n  isAuto: boolean;\n}) {\n  try {\n    // check size\n    if (\n      (isAuto && size && size > 50 * 1024 * 1024) ||\n      (!isAuto && size && size > 100 * 1024 * 1024)\n    ) {\n      showMessage.info(\"File too large to summarize\");\n      newMessage = {\n        ...newMessage,\n        content: JSON.stringify({\n          message,\n          errorMsg: \"File too large to summarize\",\n          isAuto,\n          status: \"error\",\n        }),\n      };\n      await sendMessageToAIRoom(newMessage);\n      return;\n    }\n    // download\n    await mediaLoader.fetch(mediaHash, 0);\n    const blobUrl = mediaLoader.getFromMemory(mediaHash);\n    if (!blobUrl) {\n      sendErrorMessage(newMessage, message, isAuto);\n      return;\n    }\n\n    const response = await fetch(blobUrl);\n    const blob = await response.blob();\n    //\n    const formData = new FormData();\n    formData.append(\"file\", blob, filename || \"audio.ogg\");\n    formData.append(\"language\", getAutoTransLang());\n    if (mimeType) formData.append(\"mimeType\", mimeType);\n\n    const summaryResponse: any = await audioAISummary(formData);\n    if (summaryResponse?.text) {\n      newMessage = {\n        ...newMessage,\n        content: JSON.stringify({\n          message,\n          summaryInfo: summaryResponse?.text,\n          isAuto,\n          status: \"success\",\n        }),\n      };\n      sendMessageToAIRoom(newMessage);\n    } else {\n      sendErrorMessage(newMessage, message, isAuto);\n    }\n  } catch (err) {\n    console.log(\"error\", err);\n    sendErrorMessage(newMessage, message, isAuto);\n  }\n}\n\nasync function handleImageToSummaryText({\n  mimeType,\n  mediaHash,\n  message,\n  newMessage,\n  isAuto,\n}: {\n  mimeType: string;\n  mediaHash: string;\n  message: ApiMessage;\n  newMessage: StoreMessage;\n  isAuto: boolean;\n}) {\n  // download\n  await mediaLoader.fetch(mediaHash, 0);\n  const blobUrl = mediaLoader.getFromMemory(mediaHash);\n  if (!blobUrl) {\n    sendErrorMessage(newMessage, message, isAuto);\n    return;\n  }\n\n  const response = await fetch(blobUrl);\n  const blob = await response.blob();\n\n  const reader = new FileReader();\n  reader.onloadend = function () {\n    const base64Data = reader.result?.toString().split(\",\")[1] || \"\";\n    imageAISummary({\n      image: `data:${mimeType};base64,` + base64Data,\n      language: getAutoTransLang(),\n    })\n      .then((response: any) => {\n        if (response?.text) {\n          newMessage = {\n            ...newMessage,\n            content: JSON.stringify({\n              message,\n              summaryInfo: JSON.stringify({ text: response?.text }),\n              isAuto,\n              status: \"success\",\n            }),\n          };\n          sendMessageToAIRoom(newMessage);\n        } else {\n          sendErrorMessage(newMessage, message, isAuto);\n        }\n      })\n      .catch((err) => {\n        console.log(\"error\", err);\n        sendErrorMessage(newMessage, message, isAuto);\n      });\n  };\n  reader.readAsDataURL(blob);\n}\n\nexport function canSummarize(message: ApiMessage) {\n  const { photo, document, webPage, voice, audio, text, video } =\n    message?.content;\n  const isUrl = checkIsUrl(text?.text);\n  const hasText = text?.text && text.text.trim() !== \"\";\n\n  return (\n    photo ||\n    document ||\n    (webPage && !hasText) ||\n    voice ||\n    audio ||\n    isUrl ||\n    video\n  );\n}\n\nexport function isHasUrl(text?: string) {\n  const urls = extractUrls(text);\n  const hasUrl = urls.length > 0;\n\n  return hasUrl;\n}\n\nexport function checkIsUrl(text?: string) {\n  return (\n    typeof text === \"string\" &&\n    /^https?:\\/\\/[\\w\\-._~:/?#[\\]@!$&'()*+,;=%]+$/i.test(text)\n  );\n}\n\nexport function checkIsImage(mimeType: string) {\n  return mimeType.startsWith(\"image/\");\n}\n\nasync function sendErrorMessage(\n  newMessage: StoreMessage,\n  message: ApiMessage,\n  isAuto: boolean\n) {\n  newMessage = {\n    ...newMessage,\n    content: JSON.stringify({\n      message,\n      isAuto,\n      status: \"error\",\n    }),\n  };\n  await sendMessageToAIRoom(newMessage);\n}\n\nexport function getAutoTransLang() {\n  const global = getGlobal();\n  const { telyAiLanguage = \"en\" } = global.settings.byKey;\n\n  return (\n    new Intl.DisplayNames([telyAiLanguage], { type: \"language\" }).of(\n      telyAiLanguage\n    ) || \"en\"\n  );\n}\n\nexport function extractUrls(text?: string): string[] {\n  if (typeof text !== \"string\") return [];\n\n  const urlRegex = /https?:\\/\\/[\\w\\-._~:/?#[\\]@!$&'()*+,;=%]+/gi;\n  return text.match(urlRegex) || [];\n}\n\nexport function checkIsVideo(mimeType: string) {\n  return [\"video/mp4\"].indexOf(mimeType) >= 0;\n}\n","/* (ignored) */","/* (ignored) */","/* (ignored) */","/* (ignored) */","/* (ignored) */","/* (ignored) */"],"names":["v4","uuidv4","eventEmitter","Actions","ChataiStores","audioAISummary","documentAISummary","imageAISummary","mentionReply","webPageAISummary","sleep","getMediaHash","mediaLoader","message","showMessage","pdfjsLib","getActions","getGlobal","selectChatMessage","selectWebPageFromMessage","GlobalWorkerOptions","workerSrc","mammoth","require","replyToMention","isAuto","isMentioned","content","text","newMessage","chatId","timestamp","Date","getTime","id","createdAt","role","annotations","type","JSON","stringify","messageId","status","sendMessageToAIRoom","language","getAutoTransLang","then","response","replys","sendErrorMessage","catch","err","console","log","photoSummary","photo","mediaHash","mimeType","handleImageToSummaryText","webPageSummary","global","webPage","url","summaryInfo","documentSummary","document","checkIsImage","checkIsVideo","handleAudioToSummaryText","filename","fileName","size","fetch","blobUrl","getFromMemory","blob","arrayBuffer","TextDecoder","decode","result","extractRawText","value","pdf","getDocument","data","promise","pdfText","i","numPages","page","getPage","getTextContent","pageText","items","map","item","str","join","voiceSummary","voice","isTranscriptionError","transcriptionId","transcriptions","transcribeAudio","newGlobal","currentMessage","voiceToAudioSummary","maxBase64Length","Math","floor","audio","info","audioSummary","videoSummary","video","storeMessage","emit","AddRoomAIMessage","errorMsg","formData","FormData","append","summaryResponse","reader","FileReader","onloadend","base64Data","toString","split","image","readAsDataURL","canSummarize","isUrl","checkIsUrl","hasText","trim","isHasUrl","urls","extractUrls","hasUrl","length","test","startsWith","telyAiLanguage","settings","byKey","Intl","DisplayNames","of","urlRegex","match","indexOf"],"ignoreList":[],"sourceRoot":""}